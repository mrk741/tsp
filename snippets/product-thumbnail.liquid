{% comment %}theme-check-disable ImgLazyLoading{% endcomment %}

{%- liquid
    unless lazy_load == false
      assign lazy = 'lazy'
    endunless
  
    assign desktop_columns = 1
    if gallery_style == 'two_columns' and media_count > 1
      assign desktop_columns = 2
    endif
  
    if media.media_type == 'image'
      assign image_class = 'image-magnify-' | append: section.settings.image_zoom
    endif
  -%}
  
  {%- capture sizes -%}
    {% if disable_max_width %}
      (max-width: 768px) 100vw, {{ max_width | times: media_width | divided_by: desktop_columns | round }}vw
    {% else %}
      (max-width: 768px) 100vw, {{ max_width | times: media_width | divided_by: desktop_columns | round }}px
    {% endif %}
  {%- endcapture -%}
  
  <div
    class="product-media-container media-type-{{ media.media_type }} gradient"
  >
    {%- if media.media_type == 'image' -%}
    <modal-opener class="product__modal-opener product__modal-opener--{{ media.media_type }} {% if section.settings.image_zoom == 'disabled' %}zoom-disabled{% endif %}" data-modal="#ProductModal-{{ modal_id }}">
      <span class="product__media-icon {% if media.media_type == 'image' %} product__media-icon--{{ section.settings.image_zoom }}{% endif %}" aria-hidden="true">
      </span>
      <div class="{% if media.preview_image == product.selected_or_first_available_variant.image %}product__media-variant-img {% endif %}product__media {% if desktop_media_ratio == 'auto' %}product__media-desktop-original{% endif %} {% if mobile_media_ratio == 'auto' %}product__media-mobile-original{% endif %} {% if fit_inside %}product__media--fit color-{{ gallery_color_scheme }} {% endif %}aspect-ratio media" {% if media_ratio == 'auto' %}style="padding-top: {{ 1 | divided_by: media.preview_image.aspect_ratio | times: 100 }}%;"{% endif %}>
        {% if onload_script != '' %}
          <figure class="lazy-image lazy-image--{{ settings.images_loading }}">
        {% endif %}
        {{ media.preview_image | image_url: width: 1946 | image_tag:
          class: image_class,
          loading: lazy,
          draggable: false,
          onload: onload_script,
          sizes: sizes,
          fetchpriority: fetchpriority,
          widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946, 2200, 2400, 2800, 3000, 3200'
        }}
        {% if onload_script != '' %}
            {% if settings.images_loading != 'fade_scale' %}
            <div class="lazy-image__preloader lazy-image__preloader--full lazy-image__preloader-{{ settings.images_loading }}" aria-hidden="true">
                <img 
                alt="{{ media.preview_image.alt | escape }}" 
                src="{{ media.preview_image | image_url: width: 10 }}"
                draggable="false"
                width="10" 
                height="10">
            </div>
            {% endif %}
        </figure>
        {% endif %}
      </div>
      <button class="product__media-toggle button--modal-opener product__media-zoom-{{ section.settings.image_zoom }}" type="button" aria-haspopup="dialog" data-media-id="{{ media.id }}">
        <span class="visually-hidden">
          {{ 'products.product.media.open_media' | t: index: position }}
        </span>
      </button>
    </modal-opener>
  {%- endif -%}
  
    {%- if media.media_type != 'image' -%}
      {%- if media.media_type == 'model' -%}
        <product-model class="deferred-media {% if fit_inside %}product__media--fit color-{{ gallery_color_scheme }} {% endif %}aspect-ratio media" data-media-id="{{ media.id }}" {% if desktop_media_ratio == 'auto' or mobile_media_ratio == 'auto' %}style="padding-top: {{ 1 | divided_by: media.preview_image.aspect_ratio | times: 100 }}%;"{% endif %}>
      {%- else -%}
        <deferred-media class="deferred-media none-autoplay {% if fit_inside %}product__media--fit color-{{ gallery_color_scheme }} {% endif %}aspect-ratio media" data-enable-autoplay="{{ autoplay }}" data-media-id="{{ media.id }}" {% if desktop_media_ratio == 'auto' or mobile_media_ratio == 'auto' %}style="padding-top: {{ 1 | divided_by: media.preview_image.aspect_ratio | times: 100 }}%;"{% endif %}>
      {%- endif -%}
      <button id="Deferred-Poster-Modal-{{ media.id }}" class="deferred-media__poster" type="button">
        <span class="deferred-media__poster-button">
          {%- if media.media_type == 'model' -%}
            <span class="visually-hidden">{{ 'products.product.media.play_model' | t }}</span>
            {%- render 'glyphs_signs', icon: '3d' -%}
          {%- else -%}
            <span class="visually-hidden">{{ 'products.product.media.play_video' | t }}</span>
            {%- render 'glyphs_interface', icon: 'play' -%}
          {%- endif -%}
        </span>
        {% if onload_script != '' %}
          <figure class="lazy-image lazy-image--{{ settings.images_loading }}">
        {% endif %}
        {{ media.preview_image | image_url: width: 1946 | image_tag:
          loading: lazy,
          sizes: sizes,
          onload: onload_script,
          widths: '246, 493, 600, 713, 823, 990, 1100, 1206, 1346, 1426, 1646, 1946'
        }}
        {% if onload_script != '' %}
          {% if settings.images_loading != 'fade_scale' %}
          <div class="lazy-image__preloader lazy-image__preloader--full lazy-image__preloader-{{ settings.images_loading }}" aria-hidden="true">
              <img 
              alt="{{ media.preview_image.alt | escape }}" 
              src="{{ media.preview_image | image_url: width: 10 }}"
              draggable="false"
              width="10" 
              height="10">
          </div>
          {% endif %}
      </figure>
      {% endif %}
      </button>
      <template>
        {%- liquid
          case media.media_type
          when 'external_video'
            assign video_class = 'js-' | append: media.host
            if media.host == 'youtube'
              echo media | external_video_url: autoplay: true, loop: loop, playlist: media.external_id | external_video_tag: class: video_class, loading: "lazy"
            else
              echo media | external_video_url: autoplay: true, loop: loop | external_video_tag: class: video_class, loading: "lazy"
            endif
          when 'video'
            echo media | media_tag: image_size: "2048x", autoplay: true, loop: loop, controls: true, preload: "none"
          when 'model'
            echo media | media_tag: image_size: "2048x", toggleable: true
          endcase
        -%}
      </template>
  
      {%- if media.media_type == 'model' -%}
        </product-model>
      {%- else -%}
        </deferred-media>
      {%- endif -%}
    {%- endif -%}
</div>  