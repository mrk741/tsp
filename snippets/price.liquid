<div class="price">
  {%- liquid
    if use_variant
      assign target = product.selected_or_first_available_variant
    else
      assign target = product
    endif
    if settings.show_selected_variant_value == true
      assign target = product.selected_or_first_available_variant
    endif
  
    assign compare_at_price = target.compare_at_price
    assign price = target.price | default: 2504
    assign money_price = price | money
    if settings.currency_code_enabled
      assign money_price = price | money_with_currency
    endif
  
    if product.available and target.compare_at_price > target.price and settings.show_badge_sale
      case settings.sale_badge_style
        when 'percentage'
          assign discount = compare_at_price | minus: price
          assign discount_percent = discount | times: 100 | divided_by: compare_at_price
          assign sale_badge = discount_percent | round | prepend: '-' | append: '%'
        when 'text'
          assign sale_badge = 'products.product.badges.sale_badge' | t
      endcase
    endif

    assign price_from = true
    if settings.show_selected_variant_value == true
      assign price_from = false
    endif
    if price_from and target == product and product.price_varies
      assign money_price = 'products.product.price.from_price_html' | t: price: money_price
    endif
  -%}
    <div class="price__wrapper flex--row">
      {%- if target.compare_at_price and compare_at_price > price %}
        {% comment %}On sale - Sale price{% endcomment %}
        <div class="price__on-sale {% if compare_at_price_color %}price--{{ compare_at_price_color }}{% endif %} {% if accent_price or bold_price %}price--bold{% endif %} {% if use_accent_color_for_price %}price--accent{% endif %}">
          <span class="visually-hidden">
            {{ 'products.product.price.sale_price' | t }}
          </span>
          <span class="sale-price">
            {{ money_price }}
          </span>
        </div>
        {%- if product.compare_at_price_varies or product.compare_at_price_max > product.price %}
          {% comment %}On sale - Regular price{% endcomment %}
          <div class="price__regular">
            <span class="visually-hidden">
              {{ 'products.product.price.regular_price' | t }}
            </span>
              <s class="regular-price {% if accent_price or bold_price %}price--bold{% endif %} {% if use_accent_color_for_price %}price--accent{% endif %}">
                {% if settings.currency_code_enabled %}
                  {{ compare_at_price | money_with_currency }}
                {% else %}
                  {{ compare_at_price | money }}
                {% endif %}
              </s>
            {% unless product.selected_or_first_available_variant.unit_price_measurement == nil %}
                <span class="visually-hidden">
                  {{ 'products.product.price.unit_price' | t }}
                </span>
                  <span class="unit-price {% if accent_price or bold_price %}price--bold{% endif %} {% if use_accent_color_for_price %}price--accent{% endif %}">
                    &#40;{{- product.selected_or_first_available_variant.unit_price | money -}}/
                      {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                        {{- product.selected_or_first_available_variant.unit_price_measurement.reference_value -}}
                      {%- endif -%}
                      {{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}&#41;
                  </span>
            {%- endunless -%}
            {% if parent_product_card == false %}
              <div class="card__badges card__badges--product {% if badge_style %}{{ badge_style }}{% if uppercase_text %} uppercase{% else %} none-uppercase{% endif %}{% if badge_style == 'subheading-font' %}{% if settings.use_heading_font_subheadings %} subheading-heading-font{% endif %}{% if settings.bolder_subheadings_font %} bold{% endif %}{% endif %}
              {% else %}caption-font{% if settings.uppercase_caption %} uppercase{% else %} none-uppercase{% endif %}{% endif %}{% unless show_badges %} visually-hidden{% endunless %}">
                {%- liquid
                  assign badge_name_1 = settings.badge_name_1 | downcase
                  assign badge_name_2 = settings.badge_name_2 | downcase
                  assign badge_name_3 = settings.badge_name_3 | downcase
                  assign badge_name_4 = settings.badge_name_4 | downcase
                -%}
                {%- if product.available and product.selected_or_first_available_variant.metafields.custom.badge != blank -%}
                  {%- for badge in product.selected_or_first_available_variant.metafields.custom.badge.value -%}
                    {% assign badge_name = badge | downcase %}
                    <span class="card__badges-item card__badges-item--metafield" 
                      {% if badge_name == badge_name_1 %}style="background-color: rgb(var(--badge-background-1)); color: rgb(var(--badge-text-1));"
                      {% elsif badge_name == badge_name_2 %}style="background-color: rgb(var(--badge-background-2)); color: rgb(var(--badge-text-2));"
                      {% elsif badge_name == badge_name_3 %}style="background-color: rgb(var(--badge-background-3)); color: rgb(var(--badge-text-3));"
                      {% elsif badge_name == badge_name_4 %}style="background-color: rgb(var(--badge-background-4)); color: rgb(var(--badge-text-4));"
                      {% elsif badge_name != badge_name_1 and badge_name != badge_name_2 and badge_name != badge_name_3 and badge_name != badge_name_4 %}style="background-color: rgb(var(--layout-text-color));"{% endif %}>
                      {{ badge }}
                    </span>
                  {%- endfor -%}
                {%- endif -%}
                {%- if product.available and product.metafields.custom.badge != blank -%}
                  {%- for badge in product.metafields.custom.badge.value -%}
                    {% assign badge_name = badge | downcase %}
                    <span class="card__badges-item card__badges-item--metafield" 
                      {% if badge_name == badge_name_1 %}style="background-color: rgb(var(--badge-background-1)); color: rgb(var(--badge-text-1));"
                      {% elsif badge_name == badge_name_2 %}style="background-color: rgb(var(--badge-background-2)); color: rgb(var(--badge-text-2));"
                      {% elsif badge_name == badge_name_3 %}style="background-color: rgb(var(--badge-background-3)); color: rgb(var(--badge-text-3));"
                      {% elsif badge_name == badge_name_4 %}style="background-color: rgb(var(--badge-background-4)); color: rgb(var(--badge-text-4));"
                      {% elsif badge_name != badge_name_1 and badge_name != badge_name_2 and badge_name != badge_name_3 and badge_name != badge_name_4 %}style="background-color: rgb(var(--layout-text-color));"{% endif %}>
                      {{ badge }}
                    </span>
                  {%- endfor -%}
                {%- endif -%}
                {%- if product.available and target.compare_at_price > target.price and settings.show_badge_sale -%}
                  <span {% if settings.sale_badge_style == 'percentage' %}dir="ltr"{% endif %} class="card__badges-item card__badges-item--sale">{{ sale_badge }}
                  </span>
                {%- endif -%}
                {%- if product.available == false and product.selected_or_first_available_variant != 'continue' and settings.show_badge_sold -%}
                  <span class="card__badges-item card__badges-item--sold">{{ 'products.product.badges.sold_out_badge' | t }}
                  </span>
                {%- endif -%}
                
                  {%- if settings.show_badge_preorder and product.template_suffix == 'preorder' -%}
                    <span class="card__badges-item card__badges-item--preorder{% unless show_badges %} visually-hidden{% endunless %}">{{ 'products.product.pre_order' | t }}
                    </span>
                  {%- endif -%}
                
              </div> 
            {% endif %}
          </div>
        {%- endif -%}
      {%- else -%}
        {% comment %}Regular price{% endcomment %}
        <div class="price__regular">
          <span class="visually-hidden">
            {{ 'products.product.price.regular_price' | t }}
          </span>
          <span class="regular-price {% if accent_price or bold_price %}price--bold{% endif %} {% if use_accent_color_for_price %}price--accent{% endif %}">
            {{ money_price }}
          </span>
          {% unless product.selected_or_first_available_variant.unit_price_measurement == nil %}
            {% comment %}Unit price{% endcomment %}
              <span class="visually-hidden">
                {{ 'products.product.price.unit_price' | t }}
              </span>
                <span class="unit-price {% if accent_price or bold_price %}price--bold{% endif %} {% if use_accent_color_for_price %}price--accent{% endif %}">
                  &#40;{{- product.selected_or_first_available_variant.unit_price | money -}}/
                    {%- if product.selected_or_first_available_variant.unit_price_measurement.reference_value != 1 -%}
                      {{- product.selected_or_first_available_variant.unit_price_measurement.reference_value -}}
                    {%- endif -%}
                    {{ product.selected_or_first_available_variant.unit_price_measurement.reference_unit }}&#41;
                </span>
          {%- endunless -%}
          {% if parent_product_card == false %}
            <div class="card__badges card__badges--product {% if badge_style %}{{ badge_style }}{% if uppercase_text %} uppercase{% else %} none-uppercase{% endif %}{% if badge_style == 'subheading-font' %}{% if settings.use_heading_font_subheadings %} subheading-heading-font{% endif %}{% if settings.bolder_subheadings_font %} bold{% endif %}{% endif %}
            {% else %}caption-font{% if settings.uppercase_caption %} uppercase{% else %} none-uppercase{% endif %}{% endif %} {% unless show_badges %} visually-hidden{% endunless %}">
              {%- liquid
                assign badge_name_1 = settings.badge_name_1 | downcase
                assign badge_name_2 = settings.badge_name_2 | downcase
                assign badge_name_3 = settings.badge_name_3 | downcase
                assign badge_name_4 = settings.badge_name_4 | downcase
              -%}
              {%- if product.available and product.selected_or_first_available_variant.metafields.custom.badge != blank -%}
                {%- for badge in product.selected_or_first_available_variant.metafields.custom.badge.value -%}
                  {% assign badge_name = badge | downcase %}
                  <span class="card__badges-item card__badges-item--metafield" 
                    {% if badge_name == badge_name_1 %}style="background-color: rgb(var(--badge-background-1)); color: rgb(var(--badge-text-1));"
                    {% elsif badge_name == badge_name_2 %}style="background-color: rgb(var(--badge-background-2)); color: rgb(var(--badge-text-2));"
                    {% elsif badge_name == badge_name_3 %}style="background-color: rgb(var(--badge-background-3)); color: rgb(var(--badge-text-3));"
                    {% elsif badge_name == badge_name_4 %}style="background-color: rgb(var(--badge-background-4)); color: rgb(var(--badge-text-4));"
                    {% elsif badge_name != badge_name_1 and badge_name != badge_name_2 and badge_name != badge_name_3 and badge_name != badge_name_4 %}style="background-color: rgb(var(--layout-text-color));"{% endif %}>
                    {{ badge }}
                  </span>
                {%- endfor -%}
              {%- endif -%}
              {%- if product.available and product.metafields.custom.badge != blank -%}
                {%- for badge in product.metafields.custom.badge.value -%}
                  {% assign badge_name = badge | downcase %}
                  <span class="card__badges-item card__badges-item--metafield" 
                    {% if badge_name == badge_name_1 %}style="background-color: rgb(var(--badge-background-1)); color: rgb(var(--badge-text-1));"
                    {% elsif badge_name == badge_name_2 %}style="background-color: rgb(var(--badge-background-2)); color: rgb(var(--badge-text-2));"
                    {% elsif badge_name == badge_name_3 %}style="background-color: rgb(var(--badge-background-3)); color: rgb(var(--badge-text-3));"
                    {% elsif badge_name == badge_name_4 %}style="background-color: rgb(var(--badge-background-4)); color: rgb(var(--badge-text-4));"
                    {% elsif badge_name != badge_name_1 and badge_name != badge_name_2 and badge_name != badge_name_3 and badge_name != badge_name_4 %}style="background-color: rgb(var(--layout-text-color));"{% endif %}>
                    {{ badge }}
                  </span>
                {%- endfor -%}
              {%- endif -%}
              {%- if product.available and target.compare_at_price > target.price and settings.show_badge_sale -%}
                <span {% if settings.sale_badge_style == 'percentage' %}dir="ltr"{% endif %} class="card__badges-item card__badges-item--sale">{{ sale_badge }}
                </span>
              {%- endif -%}
              {%- if product.available == false and product.selected_or_first_available_variant != 'continue' and settings.show_badge_sold -%}
                <span class="card__badges-item card__badges-item--sold">{{ 'products.product.badges.sold_out_badge' | t }}
                </span>
              {%- endif -%}
              {%-  if settings.show_badge_preorder and product.template_suffix == 'preorder' -%}
                <span class="card__badges-item card__badges-item--preorder">{{ 'products.product.pre_order' | t }}
                </span>
              {%- endif -%}
            </div>
          {% endif %}
        </div>
      {%- endif -%}
      
    </div>
</div>